# app/ai/correlation/file_malware_link.py

from __future__ import annotations

from typing import Any, Dict, List, Optional

from .base_rule import CorrelationRule
from app.models.ai_signal import AISignal


class FileMalwareLinkRule(CorrelationRule):
    name = "FileMalwareLinkRule"
    window_minutes = 15

    def process(
        self,
        org,
        device,
        aisignal: AISignal,
        raw: Optional[Dict[str, Any]] = None,
    ) -> List[Dict[str, Any]]:
        org_id = org.id
        device_id = getattr(device, "id", None)

        if aisignal.category not in ("file", "malware"):
            return []

        rule_label = "Multi-Stage Malware Activity"
        if self._dedup_correlation(org_id, device_id, rule_label, minutes=self.window_minutes):
            return []

        signals = self._recent_signals_for_device(
            device_id=device_id,
            org_id=org_id,
            minutes=self.window_minutes,
        )

        has_mal = any(s.category in ("file", "malware") and s.severity in ("high", "critical") for s in signals)
        has_proc = any(s.category == "process" and s.severity in ("high", "critical") for s in signals)
        has_net = any(s.category == "network" and s.severity in ("high", "critical") for s in signals)

        # Balanced: require malware + at least ONE of process/network
        if not (has_mal and (has_proc or has_net)):
            return []

        detail = (
            "Malicious or suspicious file activity was observed along with high-risk process or "
            "network behavior in the last 15 minutes. This strongly suggests an active malware infection."
        )

        mitigation = (
            "Immediately isolate the endpoint, block related hashes and domains, "
            "run a full malware scan, and perform incident response (containment, eradication, recovery)."
        )

        return [
            self._build_corr_event(
                category="malware",
                severity="critical",
                rule_name=rule_label,
                detail=detail,
                risk_score=92,
                mitigation=mitigation,
            )
        ]
