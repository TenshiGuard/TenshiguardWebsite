{% extends "dashboard/base_dashboard.html" %}
{% block title %}Manage Users ¬∑ TenshiGuard{% endblock %}

{% block dash_content %}
<div class="container-fluid">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h4 class="fw-semibold text-accent mb-0">Manage Users</h4>
      <small class="text-muted">Organization: {{ org.name if org else 'N/A' }}</small>
    </div>
    <a href="{{ url_for('dashboard.add_user') }}" class="btn btn-accent btn-sm">
      <i class="fa-solid fa-user-plus me-2"></i>Add User
    </a>
  </div>

  {% if limit_reached %}
  <div class="alert alert-warning small border-warning text-dark">
    ‚ö†Ô∏è User limit reached for your plan ({{ max_users }} users). Upgrade to add more.
  </div>
  {% endif %}

  {% if users %}
  <div class="card tg-card">
    <div class="card-header">
      <i class="fa-solid fa-users me-2"></i><strong>Registered Users</strong>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover align-middle mb-0">
        <thead class="small text-uppercase text-accent">
          <tr>
            <th scope="col">Username</th>
            <th scope="col">Email</th>
            <th scope="col" class="text-center">Role</th>
            <th scope="col" class="text-center">Status</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td class="text-muted small">{{ user.email }}</td>
            <td class="text-center">
              {% if user.role == 'admin' %}
              <span class="badge bg-accent text-dark">ADMIN</span>
              {% else %}
              <span class="badge bg-secondary">USER</span>
              {% endif %}
            </td>

            <!-- ‚úÖ Fixed to use is_enabled instead of is_active -->
            <td class="text-center">
              {% if user.is_enabled %}
              <span class="badge bg-success">Active</span>
              {% else %}
              <span class="badge bg-danger">Inactive</span>
              {% endif %}
            </td>

            <td class="text-end">
              <div class="btn-group btn-group-sm">

                <!-- ‚úèÔ∏è Edit -->
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#editModal{{ user.id }}"
                  title="Edit User">
                  <i class="fa-solid fa-pen"></i>
                </button>

                <!-- üîÅ Activate/Deactivate -->
                <a href="{{ url_for('dashboard.deactivate_user', user_id=user.id) }}" class="btn btn-outline-warning"
                  title="Activate/Deactivate">
                  {% if user.is_enabled %}
                  <i class="fa-solid fa-user-slash"></i>
                  {% else %}
                  <i class="fa-solid fa-user-check"></i>
                  {% endif %}
                </a>

                <!-- üöÄ Promote/Demote (Only for higher plans and not self) -->
                {% if sub and sub.plan != 'basic' and user.id != current_user.id %}
                <a href="{{ url_for('dashboard.promote_user', user_id=user.id) }}" class="btn btn-outline-info"
                  title="Promote/Demote">
                  {% if user.role == 'user' %}
                  <i class="fa-solid fa-arrow-up"></i>
                  {% else %}
                  <i class="fa-solid fa-arrow-down"></i>
                  {% endif %}
                </a>
                {% endif %}

                <!-- üóëÔ∏è Delete -->
                {% if user.id != current_user.id %}
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.id }}"
                  title="Delete User">
                  <i class="fa-solid fa-trash"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>

          <!-- ‚úèÔ∏è Edit Modal -->
          <div class="modal fade" id="editModal{{ user.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content tg-card">
                <div class="modal-header border-0">
                  <h6 class="modal-title text-accent fw-semibold">
                    <i class="fa-solid fa-pen me-2"></i>Edit User ‚Äî {{ user.username }}
                  </h6>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('dashboard.edit_user', user_id=user.id) }}">
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label small text-muted">Username</label>
                      <input type="text" class="form-control bg-dark text-light border-secondary" name="username"
                        value="{{ user.username }}">
                    </div>
                    <div class="mb-3">
                      <label class="form-label small text-muted">Email</label>
                      <input type="email" class="form-control bg-dark text-light border-secondary" name="email"
                        value="{{ user.email }}">
                    </div>
                    <div class="mb-3">
                      <label class="form-label small text-muted">New Password (optional)</label>
                      <input type="password" class="form-control bg-dark text-light border-secondary" name="password"
                        placeholder="Leave blank to keep unchanged">
                    </div>
                  </div>
                  <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-accent">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- üóëÔ∏è Delete Modal -->
          <div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content tg-card border-danger">
                <div class="modal-header border-0">
                  <h6 class="modal-title text-danger fw-semibold">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>Confirm Delete
                  </h6>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p class="small text-muted mb-1">
                    Are you sure you want to delete <strong>{{ user.username }}</strong>?
                  </p>
                  <p class="small text-danger mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer border-0">
                  <form method="POST" action="{{ url_for('dashboard.delete_user', user_id=user.id) }}">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                      <i class="fa-solid fa-trash me-1"></i> Delete
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <div class="alert alert-secondary text-center">
    <i class="fa-solid fa-user-group me-2"></i>No users found under this organization.
  </div>
  {% endif %}
</div>
{% endblock %}