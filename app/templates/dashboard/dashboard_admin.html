{% extends "dashboard/base_dashboard.html" %}
{% block dash_content %}

<div class="container-fluid px-0">

  <!-- HEADER -->
  <div class="tg-section-header mt-2 mb-4">
    <h3 class="fw-bold text-accent mb-0">
      <i class="fa-solid fa-shield-halved me-2"></i>
      Admin Dashboard
    </h3>
    <p class="text-muted small">Realtime monitoring of devices, events, and suspicious activity.</p>
  </div>

  <!-- METRICS ROW -->
  <div class="row g-3">

    <div class="col-md-3">
      <div class="tg-metric-card">
        <div class="label">TOTAL DEVICES</div>
        <div class="value">{{ agg.total }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="tg-metric-card">
        <div class="label">ONLINE</div>
        <div class="value text-success">{{ agg.online }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="tg-metric-card">
        <div class="label">OFFLINE</div>
        <div class="value text-danger">{{ agg.offline }}</div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="tg-metric-card">
        <div class="label">EVENTS (24H)</div>
        <div class="value text-info">{{ events|length }}</div>
      </div>
    </div>

  </div>

  <!-- FAILED LOGINS + TREND -->
  <div class="row g-3 mt-1">
    <div class="col-md-3">
      <div class="tg-metric-card">
        <div class="label">FAILED LOGINS (24H)</div>
        <div class="value text-warning">{{ agg.unusual }}</div>
      </div>
    </div>
  </div>

  <!-- FAILED LOGIN TREND CHART -->
  <div class="row g-4 mt-2">
    <div class="col-md-12">
      <div class="tg-panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-chart-line me-2 text-warning"></i>Failed Login Trend (24h)</span>
        </div>
        <div class="panel-body">
          <canvas id="chart-failed-logins"></canvas>
        </div>
      </div>
    </div>

    <!-- SEVERITY CHART -->
    <div class="col-md-6">
      <div class="tg-panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-signal me-2 text-accent"></i>Events by Severity (24h)</span>
        </div>
        <div class="panel-body">
          <canvas id="chart-severity"></canvas>
        </div>
      </div>
    </div>

    <!-- OS CHART -->
    <div class="col-md-6">
      <div class="tg-panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-desktop me-2 text-success"></i>Devices by OS</span>
        </div>
        <div class="panel-body">
          <canvas id="chart-os"></canvas>
        </div>
      </div>
    </div>

    <!-- PERFORMANCE CHART -->
    <div class="col-md-12">
      <div class="tg-panel">
        <div class="panel-header">
          <span><i class="fa-solid fa-microchip me-2 text-info"></i>System Performance Trend (24h)</span>
        </div>
        <div class="panel-body">
          <canvas id="chart-performance"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLES -->
  <div class="row g-4 mt-3">

    <!-- Top Devices -->
    <div class="col-md-6">
      <!-- Latest Events -->
      <div class="col-md-6">
        <div class="tg-panel">

        </div>

        <script>
          const chartData = {{ chart_data | tojson | safe }};
          const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

          const colors = {
            secondary: getCssVar('--tg-accent-secondary') || '#bc13fe',
            success: getCssVar('--tg-accent-success') || '#00ff9d',
            warning: getCssVar('--tg-accent-warning') || '#ffb600',
            danger: getCssVar('--tg-accent-danger') || '#ff0055',
            info: getCssVar('--tg-accent-info') || '#2f80ed',
            text: getCssVar('--tg-text-main') || '#e6edf3',
            grid: 'rgba(255, 255, 255, 0.05)'
          };

          const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: colors.text, font: { family: 'Inter' } } }
            },
            scales: {
              x: { grid: { color: colors.grid }, ticks: { color: colors.text } },
              y: { grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
          };

          // 1. Events by Severity (Doughnut)
          const ctxSeverity = document.getElementById("chart-severity").getContext("2d");
          new Chart(ctxSeverity, {
            type: "doughnut",
            data: {
              labels: ["Critical", "High", "Medium", "Low", "Info"],
              datasets: [{
                data: chartData.severityCounts || [0, 0, 0, 0, 0],
                backgroundColor: [colors.danger, '#ff5e00', colors.warning, colors.success, colors.info],
                borderColor: 'transparent',
                hoverOffset: 10
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'right', labels: { color: colors.text } } },
              cutout: '70%'
            }
          });

          // 2. OS Chart (Doughnut)
          const ctxOS = document.getElementById("chart-os").getContext("2d");
          new Chart(ctxOS, {
            type: "doughnut",
            data: {
              labels: ["Windows", "Linux", "macOS", "Other"],
              datasets: [{
                data: chartData.osCounts || [0, 0, 0, 0],
                backgroundColor: [colors.info, colors.warning, colors.secondary, '#6c757d'],
                borderColor: 'transparent',
                hoverOffset: 10
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'right', labels: { color: colors.text } } },
              cutout: '70%'
            }
          });

          // 3. Failed Logins Trend (Line with Area)
          const ctxLogin = document.getElementById("chart-failed-logins").getContext("2d");

          // Create gradient
          const gradient = ctxLogin.createLinearGradient(0, 0, 0, 400);
          gradient.addColorStop(0, 'rgba(255, 182, 0, 0.4)');
          gradient.addColorStop(1, 'rgba(255, 182, 0, 0)');

          new Chart(ctxLogin, {
            type: "line",
            data: {
              labels: ["-20h", "-16h", "-12h", "-8h", "-4h", "Now"],
              datasets: [{
                label: "Failed Logins",
                data: chartData.failedLogins || [0, 0, 0, 0, 0, 0],
                borderColor: colors.warning,
                backgroundColor: gradient,
                borderWidth: 2,
                pointBackgroundColor: colors.warning,
                pointBorderColor: '#fff',
                fill: true,
                tension: 0.4
              }]
            },
            options: commonOptions
          });

          // 4. Performance Trend (Line)
          const ctxPerf = document.getElementById("chart-performance").getContext("2d");
          new Chart(ctxPerf, {
            type: "line",
            data: {
              labels: ["-20h", "-16h", "-12h", "-8h", "-4h", "Now"],
              datasets: [
                {
                  label: "Avg CPU %",
                  data: chartData.cpuTrend || [0, 0, 0, 0, 0, 0],
                  borderColor: colors.info,
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  tension: 0.4
                },
                {
                  label: "Avg Mem %",
                  data: chartData.memTrend || [0, 0, 0, 0, 0, 0],
                  borderColor: colors.secondary,
                  backgroundColor: 'transparent',
                  borderWidth: 2,
                  tension: 0.4
                }
              ]
            },
            options: commonOptions
          });
        </script>
        {% endblock %}