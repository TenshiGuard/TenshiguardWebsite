ai_correlation.html{% extends "dashboard/base_dashboard.html" %}
{% block title %}AI Correlation Incidents · TenshiGuard{% endblock %}

{% block dash_content %}
<div class="container-fluid py-3" id="ai-correlation-root">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="fw-semibold mb-0 text-accent">AI Correlation Incidents</h4>
      <small class="text-muted">
        High-level stories generated by the AI correlation engine in the last 24 hours.
      </small>
    </div>
    <button class="btn btn-outline-light btn-sm" id="corrRefreshBtn">
      <i class="fa-solid fa-rotate me-2"></i> Refresh
    </button>
  </div>

  <div class="tg-card p-0 shadow-card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr class="text-accent">
            <th style="min-width: 170px;">Time (UTC)</th>
            <th>Severity</th>
            <th>Category</th>
            <th style="min-width: 180px;">Device / MAC</th>
            <th style="min-width: 220px;">Correlation Story</th>
            <th style="width: 140px;">Correlation Score</th>
          </tr>
        </thead>
        <tbody id="corrIncidentsTableBody">
          <tr>
            <td colspan="6" class="text-center text-muted py-3">
              Loading correlation incidents...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tbody = document.getElementById("corrIncidentsTableBody");
  const btn = document.getElementById("corrRefreshBtn");
  let lastSnapshot = "";

  async function loadCorrelationIncidents() {
    try {
      const res = await fetch("/api/ai/correlation/incidents");
      const data = await res.json();

      if (data.status !== "ok") {
        throw new Error(data.message || "API error");
      }

      if (!data.incidents || data.incidents.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted py-3">
              No correlation incidents in the last 24 hours.
            </td>
          </tr>
        `;
        return;
      }

      const snapshot = JSON.stringify(data.incidents);
      if (snapshot === lastSnapshot) {
        return; // no change
      }
      lastSnapshot = snapshot;

      tbody.innerHTML = data.incidents.map(inc => {
        const sevClass = severityClass(inc.severity);
        const catClass = categoryClass(inc.category);
        const corrHtml = correlationBadge(inc.correlation_score);

        return `
          <tr class="corr-row">
            <td class="text-nowrap">${inc.time}</td>
            <td>
              <span class="severity-badge ${sevClass}">
                ${inc.severity.toUpperCase()}
              </span>
            </td>
            <td>
              <span class="badge rounded-pill ${catClass}">
                ${inc.category}
              </span>
            </td>
            <td>
              <div class="d-flex flex-column">
                <span>${inc.device}</span>
                <small class="text-muted">${inc.mac}</small>
              </div>
            </td>
            <td class="small">
              ${escapeHtml(inc.detail || "—")}
            </td>
            <td class="text-center">
              ${corrHtml}
            </td>
          </tr>
        `;
      }).join("");

      document
        .querySelectorAll("#corrIncidentsTableBody .corr-row")
        .forEach(row => {
          row.classList.add("flash-row");
          setTimeout(() => row.classList.remove("flash-row"), 1000);
        });

    } catch (err) {
      console.error("Correlation incidents fetch failed:", err);
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-danger text-center py-3">
            Error loading correlation incidents
          </td>
        </tr>
      `;
    }
  }

  function severityClass(sev) {
    if (!sev) return "severity-info";
    switch (sev.toLowerCase()) {
      case "critical": return "severity-critical";
      case "high":     return "severity-high";
      case "medium":   return "severity-medium";
      case "low":      return "severity-low";
      case "info":
      default:         return "severity-info";
    }
  }

  function categoryClass(cat) {
    if (!cat) return "badge-secondary";
    switch (cat.toLowerCase()) {
      case "bruteforce":
      case "auth":        return "badge-auth";
      case "cryptominer": return "badge-network";
      case "ransomware":  return "badge-file";
      case "c2":          return "badge-network";
      case "privilege_escalation":
        return "badge-process";
      default:
        return "badge-secondary";
    }
  }

  function correlationBadge(scoreRaw) {
    const score = parseInt(scoreRaw || 0, 10) || 0;
    if (!score) {
      return `<span class="text-muted">—</span>`;
    }

    let cls = "badge-corr-low";
    let label = "Weak";

    if (score >= 80) {
      cls = "badge-corr-high";
      label = "Strong";
    } else if (score >= 50) {
      cls = "badge-corr-med";
      label = "Linked";
    }

    return `
      <span class="badge rounded-pill ${cls}">
        ${label} (${score})
      </span>
    `;
  }

  function escapeHtml(str) {
    return (str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  btn.addEventListener("click", loadCorrelationIncidents);

  loadCorrelationIncidents();
  setInterval(loadCorrelationIncidents, 10000);
});
</script>
{% endblock %}
